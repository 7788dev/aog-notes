---
tags:
  - 进阶
  - 搜索
  - BM25
date: 2024-12-19
---

# 搜索引擎

AOG Notes 内置了一个高性能的全文搜索引擎，支持中文分词和模糊匹配。

## 功能特性

- 基于 BM25 算法的相关性排序
- 中文 N-gram 分词，无需词典
- 标题加权匹配
- 模糊匹配支持
- 实时搜索，200ms 防抖
- 搜索结果高亮显示

## 工作原理

### BM25 算法

BM25 (Best Matching 25) 是一种经典的信息检索算法，被广泛应用于搜索引擎中。

通过以下因素计算文档相关性：

- **词频 (TF)** - 关键词在文档中出现的次数
- **逆文档频率 (IDF)** - 关键词的稀有程度
- **文档长度** - 较短文档中的匹配权重更高

### 核心参数

```typescript
const BM25_K1 = 1.5  // 词频饱和参数
const BM25_B = 0.5   // 文档长度归一化参数
```

- `K1` 控制词频的影响程度，值越大词频影响越大
- `B` 控制文档长度的影响，0 表示不考虑长度，1 表示完全归一化

## 中文分词

搜索引擎使用 N-gram 方式处理中文，无需外部词典：

```typescript
function tokenize(text: string): string[] {
  const tokens: string[] = []
  
  // 提取英文单词
  const englishWords = text.toLowerCase().match(/[a-z][a-z0-9]*/g) || []
  tokens.push(...englishWords)
  
  // 中文 N-gram (1-3 字)
  for (let i = 0; i < text.length; i++) {
    const char = text[i]
    if (/[\u4e00-\u9fa5]/.test(char)) {
      tokens.push(char)                    // 单字
      if (i + 1 < text.length) {
        tokens.push(text.slice(i, i + 2))  // 双字
      }
      if (i + 2 < text.length) {
        tokens.push(text.slice(i, i + 3))  // 三字
      }
    }
  }
  
  return tokens
}
```

### 分词示例

输入：`JavaScript 入门教程`

输出：
- 英文：`javascript`
- 中文：`入`, `入门`, `入门教`, `门`, `门教`, `门教程`, `教`, `教程`, `程`

## 搜索特性

### 标题加权

标题匹配的权重是正文的 5 倍：

```typescript
const fieldWeights = {
  title: 5.0,
  content: 1.0
}
```

### 位置加权

根据匹配位置给予额外加分：

| 匹配位置 | 加分 |
|----------|------|
| 完全匹配标题 | +100 |
| 标题开头匹配 | +50 |
| 标题包含匹配 | +30 |
| 正文开头匹配 | +5 |

### 模糊匹配

当精确匹配结果不足时，启用基于编辑距离的模糊匹配：

```typescript
function fuzzyMatch(query: string, text: string): boolean {
  const distance = levenshteinDistance(query, text)
  const maxLen = Math.max(query.length, text.length)
  const similarity = 1 - distance / maxLen
  return similarity >= 0.7  // 70% 相似度阈值
}
```

## 使用方式

### 基本搜索

在搜索框中输入关键词即可搜索，支持：

- 中文关键词：`配置`
- 英文关键词：`markdown`
- 混合搜索：`Next.js 部署`
- 多词搜索：`搜索 引擎`（空格分隔）

### 快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl + K` / `Cmd + K` | 聚焦搜索框 |
| `Esc` | 清空搜索 |
| `↑` / `↓` | 切换结果 |
| `Enter` | 打开选中结果 |

### 搜索结果

- 结果按相关性排序
- 关键词高亮显示
- 显示匹配的内容片段
- 最多返回 50 条结果

## 性能优化

### 索引构建

搜索引擎在页面加载时构建倒排索引：

```typescript
interface InvertedIndex {
  [token: string]: {
    docId: number
    tf: number      // 词频
    positions: number[]  // 出现位置
  }[]
}
```

### 复杂度分析

| 操作 | 时间复杂度 | 说明 |
|------|------------|------|
| 索引构建 | O(n × m) | n=文档数，m=平均长度 |
| 搜索查询 | O(k × d) | k=关键词数，d=匹配文档数 |
| 内存占用 | O(n × m) | 约为原文档 2-3 倍 |

### 性能数据

| 文档数量 | 索引时间 | 搜索时间 |
|----------|----------|----------|
| 100 篇 | < 50ms | < 5ms |
| 500 篇 | < 200ms | < 10ms |
| 1000 篇 | < 500ms | < 20ms |

## 配置选项

在 `site.config.ts` 中配置：

```typescript
features: {
  search: true,  // 启用/禁用搜索
}
```

## 搜索引擎源码

搜索引擎实现位于 `src/lib/search.ts`，主要类：

```typescript
class SearchEngine {
  constructor(documents: Document[])
  search(query: string, options?: SearchOptions): SearchResult[]
  addDocument(doc: Document): void
  removeDocument(docId: number): void
}

interface SearchOptions {
  fuzzy?: boolean    // 启用模糊匹配
  limit?: number     // 结果数量限制
  fields?: string[]  // 搜索字段
}

interface SearchResult {
  item: Document
  score: number
  matches: Match[]
}
```

## 扩展搜索

如需更强大的搜索功能，可以考虑：

- **Algolia** - 托管搜索服务，支持高级功能
- **MeiliSearch** - 开源搜索引擎，支持自托管
- **Elasticsearch** - 企业级搜索解决方案

这些方案需要额外的服务器或服务费用。
